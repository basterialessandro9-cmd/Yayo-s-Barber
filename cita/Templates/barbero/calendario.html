{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario del Barbero</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #111; color: #fff; font-family: Arial; }
    #calendar { max-width: 90%; margin: 40px auto; background: #1c1c1c; padding: 20px; border-radius: 12px; }
    .fc-toolbar-title { color: #FFD700 !important; }

    @media (max-width: 768px) {
  #calendar {
    max-width: 100%;
    margin: 10px auto;
    padding: 10px;
  }
  .fc-toolbar {
    flex-wrap: wrap;
    gap: 5px;
  }
  .fc-toolbar-title {
    font-size: 1.1rem;
  }
}

  </style>
</head>
<body>
  {% include "inc/headerb.html" %}
  <div class="main-wrapper">
    {% include "inc/topbarb.html" %}
    {% include "inc/sidebarb.html" %}

    <div class="page-wrapper">
      <div class="container-fluid">
        
        <!-- Encabezado -->
        <div class="row page-titles d-flex align-items-center">
          <div class="col-md-5 align-self-center">
            <h3 class="text-themecolor m-0">Calendario de Citas</h3>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#">Barbero</a></li>
              <li class="breadcrumb-item active">Calendario</li>
            </ol>
          </div>
        </div>

        <div id="calendar"></div>

      </div>
    </div>
  </div>
  {% include "inc/footerb.html" %}

  <script>
    // ---- funci√≥n para obtener el CSRF desde cookies ----
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    document.addEventListener("DOMContentLoaded", function() {
      var calendarEl = document.getElementById("calendar");
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "es",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },
        events: "/api/citas-barbero/", // üëà debe devolver JSON con {id, start, end}
        eventClick: function(info) {
          Swal.fire({
            title: "¬øMarcar cita como completada?",
            text: info.event.title,
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "S√≠, completar",
            cancelButtonText: "Cancelar"
          }).then((result) => {
            if (result.isConfirmed) {
              fetch(`/api/cita-completar/${info.event.id}/`, {
                method: "POST",
                headers: {
                  "X-CSRFToken": csrftoken,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({})
              })
              .then(r => r.json())
              .then(data => {
                if (data.success) {
                  // üî• Cambiar color en caliente
                  info.event.setProp("backgroundColor", "#28a745");
                  info.event.setProp("borderColor", "#28a745");

                  Swal.fire({
                    title: "¬°Completada!",
                    text: "La cita fue marcada como completada.",
                    icon: "success",
                    timer: 2000,
                    showConfirmButton: false
                  });
                } else {
                  Swal.fire("Error", data.error, "error");
                }
              })
              .catch(err => {
                console.error("Error:", err);
                Swal.fire("Error", "Hubo un problema con el servidor.", "error");
              });
            }
          });
        }
      });
      calendar.render();
    });
  </script>
</body>
</html>
