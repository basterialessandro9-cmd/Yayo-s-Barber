{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil del Cliente</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="{% static 'Css/bootstrap.css' %}">
  <link rel="stylesheet" href="{% static 'Css/perfil_cliente.css' %}">
  <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .avatar-circle {
      width: 90px; height: 90px;
      background: linear-gradient(135deg, #f5d06c, #e0b84f);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 36px; font-weight: bold; color: #111;
      margin: auto;
    }
    
    .card-shadow-lg {
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      border-radius: 12px;
      transition: transform 0.2s ease-in-out;
    }
    
    .card-shadow-lg:hover { transform: scale(1.01); }
    .text-gold { color: #f5d06c; }
    
    .agenda { 
      background: #f5d06c; 
      color: #111; 
      border-radius: 8px; 
      font-weight: bold;
      white-space: nowrap;
    }
    
    .agenda:hover { background: #e0b84f; }

    .estado-confirmada { color: #ffc107; font-weight: bold; }
    .estado-completada { color: #28a745; font-weight: bold; }
    .estado-cancelada { color: #dc3545; font-weight: bold; }

    .resumen { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .resumen .box {
      background: #111; 
      color: #f5d06c;
      text-align: center; 
      padding: 20px;
      border-radius: 10px;
      transition: transform 0.2s;
    }
    
    .resumen .box:hover {
      transform: translateY(-2px);
    }
    
    .resumen .box h3 { 
      margin: 0; 
      font-size: 28px; 
    }
    
    .resumen .box p { 
      margin: 0; 
      font-size: 14px; 
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding-left: 10px !important;
        padding-right: 10px !important;
      }
      
      .avatar-circle {
        width: 70px; 
        height: 70px;
        font-size: 28px;
      }
      
      .card-body {
        padding: 1rem !important;
      }
      
      .resumen {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }
      
      .resumen .box {
        padding: 15px 10px;
      }
      
      .resumen .box h3 {
        font-size: 22px;
      }
      
      .resumen .box p {
        font-size: 12px;
      }
      
      /* Header de la tabla responsive */
      .card-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .card-header h4 {
        font-size: 1.1rem;
        margin-bottom: 0 !important;
      }
      
      /* Botones más pequeños en móvil */
      .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }
      
      /* Ocultar algunos textos en móvil */
      .btn-sm .d-none-mobile {
        display: none;
      }
    }

    @media (max-width: 576px) {
      .py-5 {
        padding-top: 2rem !important;
        padding-bottom: 2rem !important;
      }
      
      .avatar-circle {
        width: 60px; 
        height: 60px;
        font-size: 24px;
      }
      
      .resumen {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      
      .resumen .box {
        padding: 12px 8px;
      }
      
      .resumen .box h3 {
        font-size: 20px;
      }
      
      .resumen .box:last-child {
        grid-column: 1 / -1;
      }
      
      /* Tabla responsive para móviles muy pequeños */
      .table-responsive {
        font-size: 0.85rem;
      }
      
      .table th,
      .table td {
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
      }
      
      /* Botones de acción apilados */
      .btn-group-mobile {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      
      .btn-group-mobile .btn {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
      }
    }

    /* Landscape móviles */
    @media (max-height: 600px) and (orientation: landscape) {
      .py-5 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
      }
      
      .resumen {
        margin-bottom: 15px;
      }
      
      .resumen .box {
        padding: 10px;
      }
    }

    /* Para pantallas extra pequeñas */
    @media (max-width: 400px) {
      .card-header h4 {
        font-size: 1rem;
      }
      
      .agenda {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
      
      .table {
        font-size: 0.8rem;
      }
      
      /* Hacer la tabla scrolleable horizontalmente */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Mejorar la experiencia táctil */
    @media (hover: none) and (pointer: coarse) {
      .card-shadow-lg:hover {
        transform: none;
      }
      
      .btn {
        min-height: 44px;
        min-width: 44px;
      }
    }
  </style>
</head>

<body>
  <div class="container py-5">

    <!-- Perfil -->
    <div class="card card-shadow-lg mb-4 bg-dark text-light">
      <div class="row g-0 align-items-center">
        <div class="col-md-3 text-center py-4">
          <div class="avatar-circle">{{ cliente.user.first_name|first|upper }}</div>
        </div>
        <div class="col-md-9">
          <div class="card-body">
            <div class="d-flex justify-content-end gap-2 mb-3">
              <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button class="btn btn-danger">
                  <i class="bi bi-box-arrow-right"></i> 
                  <span class="d-none d-sm-inline">Cerrar Sesión</span>
                  <span class="d-sm-none">Salir</span>
                </button>
              </form>
            </div>
            <h2 class="card-title mb-2 text-gold">¡Hola, {{ cliente.user.first_name }}!</h2>
            <div class="row">
              <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center mb-1">
                  <i class="bi bi-person me-2"></i> 
                  <strong>Nombre:</strong> 
                  <span class="ms-1">{{ cliente.user.first_name }}</span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="bi bi-envelope me-2"></i> 
                  <strong>Correo:</strong> 
                  <span class="ms-1 text-break">{{ cliente.user.email }}</span>
                </div>
              </div>
              <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center">
                  <i class="bi bi-phone me-2"></i> 
                  <strong>Teléfono:</strong> 
                  <span class="ms-1">{{ cliente.telefono }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="resumen">
      <div class="box">
        <h3>{{ citas|length }}</h3>
        <p>Total Citas</p>
      </div>
      <div class="box">
        {% if proxima_cita %}
          <h3>{{ proxima_cita.inicio|date:"d/m" }}</h3>
        {% else %}
          <h3>—</h3>
        {% endif %}
        <p>Próxima Cita</p>
      </div>
      <div class="box">
        <h3>{{ completadas_count }}</h3>
        <p>Completadas</p>
      </div>
    </div>

    <!-- Citas -->
    <div class="card card-shadow-lg">
      <div class="card-header bg-dark text-light d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-calendar-event"></i> 
          <span class="d-none d-sm-inline">Citas Agendadas</span>
          <span class="d-sm-none">Citas</span>
        </h4>
        <a href="{% url 'agendar_cita_nuevo' %}" class="btn agenda">
          <i class="bi bi-calendar-check"></i> 
          <span class="d-none d-sm-inline">Agendar cita</span>
          <span class="d-sm-none">Agendar</span>
        </a>
      </div>
      <div class="card-body p-0">
        {% if citas %}
          <div class="table-responsive table-wrapper">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th class="d-none d-md-table-cell">Servicios</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for cita in citas %}
                  <tr>
                    <td>{{ cita.inicio|date:"d/m/Y" }}</td>
                    <td>{{ cita.inicio|time:"H:i" }}</td>
                    <td class="d-none d-md-table-cell">
                      {% for s in cita.servicios.all %}
                        {{ s.nombre }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </td>
                    <td>
                      <span class="estado-{{ cita.estado }}">
                        <span class="d-none d-sm-inline">{{ cita.get_estado_display }}</span>
                        <span class="d-sm-none">
                          {% if cita.estado == "confirmada" %}✓{% endif %}
                          {% if cita.estado == "completada" %}✓✓{% endif %}
                          {% if cita.estado == "cancelada" %}✗{% endif %}
                        </span>
                      </span>
                    </td>
                    <td>
                      <div class="d-none d-sm-block">
                        <!-- Botón Eliminar (solo completadas) -->
                        {% if cita.estado == "completada" %}
                          <a href="{% url 'eliminar_cita' cita.id %}" 
                             class="btn btn-sm btn-danger me-1"
                             onclick="confirmarAccion(event, this.href, '¿Seguro que quieres eliminar esta cita?', 'Sí, eliminar')">
                            <i class="bi bi-trash3"></i> Eliminar
                          </a>
                        {% else %}
                          <button class="btn btn-sm btn-danger me-1" disabled title="Solo puedes eliminar citas completadas">
                            <i class="bi bi-trash3"></i> Eliminar
                          </button>
                        {% endif %}

                        <!-- Botón Cancelar (solo confirmadas y +2 horas) -->
                        {% if cita.estado == "confirmada" %}
                          {% if cita.inicio|date:"U"|add:"-7200"|floatformat:0 > ahora|date:"U"|floatformat:0 %}
                            <a href="{% url 'cancelar_cita' cita.id %}" class="btn btn-sm btn-warning"
                               onclick="confirmarAccion(event, this.href, '¿Seguro que quieres cancelar esta cita?', 'Sí, cancelar')">
                              <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                          {% else %}
                            <button class="btn btn-sm btn-warning" disabled title="No puedes cancelar a menos de 2 horas">
                              <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                          {% endif %}
                        {% endif %}
                      </div>
                      
                      <!-- Versión móvil - botones apilados -->
                      <div class="d-sm-none btn-group-mobile">
                        {% if cita.estado == "completada" %}
                          <a href="{% url 'eliminar_cita' cita.id %}" 
                             class="btn btn-sm btn-danger"
                             onclick="confirmarAccion(event, this.href, '¿Eliminar cita?', 'Sí')">
                            <i class="bi bi-trash3"></i>
                          </a>
                        {% endif %}
                        
                        {% if cita.estado == "confirmada" %}
                          {% if cita.inicio|date:"U"|add:"-7200"|floatformat:0 > ahora|date:"U"|floatformat:0 %}
                            <a href="{% url 'cancelar_cita' cita.id %}" class="btn btn-sm btn-warning"
                               onclick="confirmarAccion(event, this.href, '¿Cancelar cita?', 'Sí')">
                              <i class="bi bi-x-circle"></i>
                            </a>
                          {% endif %}
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info text-center mb-0">
            <i class="bi bi-info-circle"></i> No tienes citas agendadas.
          </div>
        {% endif %}
      </div>
    </div>

  </div>

  <script src="{% static 'Js/bootstrap.bundle.js' %}"></script>

  <script>
    // Confirmación para cancelar/eliminar
    function confirmarAccion(event, url, mensaje, textoConfirmar) {
      event.preventDefault();
      Swal.fire({
        title: mensaje,
        icon: 'warning',
        background: '#111',
        color: '#f5d06c',
        showCancelButton: true,
        confirmButtonColor: '#f5d06c',
        cancelButtonColor: '#6c757d',
        confirmButtonText: textoConfirmar,
        cancelButtonText: 'No, volver',
        customClass: {
          popup: 'rounded-4 shadow-lg',
          confirmButton: 'fw-bold',
          cancelButton: 'fw-bold'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    }

    // SweetAlerts de éxito según parámetros en la URL
    document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);

      if (params.has("agendada")) {
        Swal.fire({
          icon: 'success',
          title: '¡Cita agendada!',
          text: 'Tu cita se registró correctamente.',
          background: '#111',
          color: '#f5d06c',
          confirmButtonColor: '#28a745',
        });
      }

      if (params.has("cancelada")) {
        Swal.fire({
          icon: 'success',
          title: '¡Cita cancelada!',
          text: 'Tu cita ha sido cancelada con éxito.',
          background: '#111',
          color: '#f5d06c',
          confirmButtonColor: '#ffc107',
        });
      }

      if (params.has("eliminada")) {
        Swal.fire({
          icon: 'success',
          title: '¡Cita eliminada!',
          text: 'Tu cita ha sido eliminada correctamente.',
          background: '#111',
          color: '#f5d06c',
          confirmButtonColor: '#dc3545',
        });
      }
    });
  </script>

</body>
</html>